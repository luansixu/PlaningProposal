# 魔鬼契约（可玩原型策划案 v0.1）

> 定位：纯 Web 文字策略/叙事原型  
> 核心乐趣：**读条款识破文字漏洞并谈判** + **由条款能力驱动的戏剧性随机事件**  
> LLM 价值：魔鬼拟人化谈判与出题、契约可执行化（JSON）、基于能力/诅咒的事件生成与判定

---

## 1. 一句话概念

你获得与魔鬼交易的权利：每一轮你必须在“收益/代价/漏洞”之间做选择与谈判；**首轮有概率出现“灵魂清零”的致命试探（按魔鬼等级）**，只有识破魔鬼真实意图才能活下来并带走财富与遗产。

---

## 2. 核心卖点（3 条）

1) **条款阅读就是战斗**：摘要很诱人，坑常藏在全文；玩家需要“指出漏洞”迫使魔鬼让步。  
2) **首轮致命试探（概率出现）**：第一轮可能出现“一句话清空灵魂”的致命试探条款，识破失败即暴毙——这是玩法，而不是 bug。  
3) **能力 → 事件引擎**：签下的能力（或诅咒）会让 LLM 在事件阶段生成更戏剧、更贴合你人生走向的抉择。

---

## 3. 目标平台与交互方式（纯 Web）

- **平台**：浏览器（桌面优先，兼容移动端）
- **主要交互**：弹窗式
  - 主界面：资源条 + 能力列表 + 当前契约摘要 + 历史契约入口
  - 点击“查看全文”打开契约全文弹窗（可滚动、可复制引用）
  - 点击“谈判”打开谈判弹窗（默认回合内最多 2 次谈判；可被能力提升但单契约上限 4 次；**不硬性限制输入字数**，但建议短句表达；超长输入可在本地先摘要再提交，以控制 token 成本）
  - 点击“法宝”在谈判弹窗内使用（每轮 1 次）

---

## 4. 玩法结构总览（闭环）

每局 2–4 轮（随机），每轮包含：

1) **回合开局结算**（数值压力）  
2) **契约生成**（LLM：魔鬼提出条款，含摘要/全文/可执行 JSON）  
3) **玩家选择**：接受 / 拒绝 / 谈判（默认最多 2 次；可被能力提升但单契约上限 4 次）  
4) **条款结算**：获得能力/诅咒，资源变化落地  
5) **随机事件阶段**（LLM：根据金币/幸福/灵魂/能力/诅咒生成事件；每轮 1–2 个，见第 10 节）  
6) **回合结束提示**：活下去了吗？这一切值得吗？  
7) 进入下一轮或结算（胜利/失败）

---

## 5. 数值与资源

### 5.1 初始值

- **幸福度**：60（范围 0–100）
- **金币**：0（范围 0+，理论无上限）
- **灵魂**：100（范围 0–100，归零即失败）

### 5.2 失败/胜利条件

- **失败**：任意时点灵魂 ≤ 0 → 弹窗：`你的灵魂已被恶魔收走`
- **胜利**：完成所有轮次后灵魂 > 0 → 进入胜利结算

### 5.3 回合开局结算（固定规则）

> 所有数值结算后执行 clamp：幸福度 \[0,100]、灵魂 \[0,100]。

1) **幸福影响灵魂**  
   - 计算：`delta = 当前幸福度 - 60`  
   - 更新：`灵魂 = 灵魂 + delta`

2) **回合税：优先扣金币 10**  
   - 若金币 ≥ 10：金币 = 金币 - 10  
   - 若金币 < 10：  
     - 先扣光金币：金币 = 0  
     - 幸福度补差：`幸福度 = 幸福度 + (原金币 - 10)`（即减少缺口；例如金币 3，则幸福度 -7）

> 设计意图：幸福高会“养魂”，贫穷会“磨人”，逼迫玩家不得不和魔鬼交易。

---

## 6. 魔鬼与契约

### 6.1 魔鬼等级（影响条款强度与灵魂变动上限）

- **实习魔鬼**：条款价值上限 100 金币量级；单次谈判（每次 LLM 改写）灵魂变化上限 **25**  
- **小魔鬼**：条款价值上限 300；单次谈判灵魂变化上限 **50**  
- **大魔鬼**：条款价值上限 1000；单次谈判灵魂变化 **无上限**（但仍必须可理解、可执行；并受“首轮致命试探”规则约束）

> 注：这里的“灵魂变化上限”用于**谈判改写阶段的增减幅度约束**（防止一次谈判把条款改得离谱/不可控）。  
> 接受条款的最终灵魂代价还受“最低消耗”约束（见 6.4）。

### 6.1.1 遭遇概率与视觉呈现（原型默认，可调）

为保证节奏与“强弱差异”可感知，建议每轮随机遭遇魔鬼等级，且在 UI 上强烈标识。

- **遭遇概率（建议默认）**
  - 实习魔鬼：35%
  - 小魔鬼：45%
  - 大魔鬼：20%
  - （可根据你试玩反馈调参；目标是平均 2–4 轮里至少出现 1 次“小魔鬼”，偶尔出现“大魔鬼”的压迫感）

- **视觉标识（必须）**
  - 实习魔鬼：灰/青色徽记（“见习”）、细边框
  - 小魔鬼：红色徽记（“狡诈”）、中等边框
  - 大魔鬼：紫/黑徽记（“主审”）、粗边框 + 轻微抖动/呼吸动画
  - 契约卡与全文弹窗顶部展示：魔鬼头像（几何拼装）、等级标签、威胁提示语

### 6.2 信息输入给 LLM（魔鬼可见）

LLM 获得玩家的资源“档位描述”与精确数值：

- 金币档位：0–50 赤贫 / 50–150 贫穷 / 150–300 小康 / 300–800 富有 / 800+ 巨富  
- 幸福档位：0–30 灾星 / 30–60 不幸 / 60 正常 / 60–70 还过得去 / 70–90 快乐 / 90–100 幸福  
- 灵魂：0–100（0 失败）

### 6.3 条款结构

每轮魔鬼随机提出 **1 条契约**，包含：

- **摘要**（玩家默认看到）：诱惑性强，隐藏风险不完全展开  
- **全文**（玩家可点开查看）：包含 0–3 个“文字漏洞”（可被识破并谈判让步）  
- **可执行数值变化**（JSON）：金币/幸福/灵魂变化、能力/诅咒、触发条件  

### 6.4 接受条款最低灵魂消耗

玩家一旦选择“接受”，则该契约 **最低消耗 10 灵魂**（即使条款看似不扣灵魂，也会以“签约印记”形式扣除 10）。  
其余灵魂变化按条款 JSON 执行。

---

## 7. 轮次核心玩法：谈判

### 7.1 玩家操作

玩家对当前条款可选择：

- **接受**：立即签约结算（获得能力/诅咒、资源变化）
- **拒绝**：
  - 第一次拒绝：魔鬼提出**新条款**（仍为本轮条款，但替换掉当前条款；可再次选择）  
  - 第二次拒绝：魔鬼退场，玩家灵魂 -10（并提示：拒绝也要付代价）
- **谈判**（本轮最多 2 次）：
  - 弹出谈判框：**不硬性限制输入字数**（建议短句；超长输入可本地摘要后提交以控成本）
  - 可选择“我指出的漏洞（引用全文句子）”并说明问题
  - 本轮谈判次数用完后，只能接受或拒绝

> 补充（你已确认）：若玩家获得“谈判次数增加”的特殊能力，可提高本轮谈判次数，但**单个契约的谈判总次数上限为 4 次**（避免拖时与成本失控）。

### 7.2 法宝机制（每轮 1 次）

- 玩家在谈判弹窗中可使用一次“法宝”  
- **效果**：提示该契约全文中存在几处错误/漏洞（数量提示），但**不明确指出答案与位置**  
- 不设置暗条款（即：不存在“系统隐藏但全文看不到”的条款）

### 7.3 文字漏洞规则（主打）

- **陷阱就是文字漏洞**：本项目是文字游戏，陷阱主要以“可读可辩的文字漏洞”呈现，并且必须落到可检测的条件字段（见第 13.3 的 JSON 结构）。

- **漏洞数量规则（你已确认）**
  - **谈判第一轮（首次出价）**：生成 **4–6 个**文字漏洞（强对抗、强乐趣）。  
  - **后续谈判回合（改写/拒绝后的新条款）**：漏洞只能被玩家找出、修改、减少或保持不变，**不能新增新漏洞**。  
    - 特例（仅大魔鬼）：当玩家指出了漏洞句子但没指出具体问题时，魔鬼允许把同一个漏洞“换一种问法”（本质仍是同一漏洞，不算新增）。
  - **0 漏洞条款**：只允许出现在“玩家已经成功识破过至少 1 次漏洞并完成改写”的情况下（作为明显奖励）。

- **陷阱总量约束**：同一轮对话中的“陷阱点”（文字漏洞 + 事件陷阱型漏洞/诅咒入口 + 首轮致命试探若出现）总数 **0–8**。

- 漏洞形式示例（用于 LLM 出题参考）：
  - 定义偷换：“爱上你”在下一段被定义为“以金钱表达爱”
  - 条件从句：“仅限一次”但后文定义“一次=每一日一次”
  - 例外条款：“除非你拒绝我一次”
  - 时间范围：“在你最幸福之日”

### 7.4 漏洞识破与让步

每次谈判，玩家可以尝试指出 1 个漏洞（或提出对价抬升/砍价）：

- **“两层条件”的判定（你已确认）**
  - **命中 1 层（指出了带坑句子/条款）**：满足“命中漏洞句”条件，魔鬼获得一次狡辩/周旋机会（是否让步取决于魔鬼等级与概率，见 7.4.1）。  
  - **命中 2 层（指出漏洞句 + 指出具体问题）**：魔鬼**无法狡辩**，必须认输并接受让步条件（进入让步改写）。

- **若识破成功（命中 2 层）**：魔鬼必须示弱（由 LLM 选择其一或组合）
  - 降低条款消耗（金币/幸福/灵魂代价变小）
  - 增加条款附带好处（收益更大/能力更强）
  - 将漏洞句改为清晰条款（把“坑点”消解为可理解可接受的条件）

- **若识破失败**：魔鬼不让步，并可能在措辞上更狡猾（但仍需可理解、可执行）

#### 7.4.1 只命中 1 层时的“拒绝后新条款”规则（你已确认）

当玩家指出了带坑语句，但没有正确指出问题（没说清具体错误原因）时，魔鬼在“拒绝后新条款/下一次出价”中的处理：

- **实习魔鬼**：直接认输，改掉该漏洞句（消解坑点）。  
- **小魔鬼**：50% 概率改掉该漏洞句；50% 概率换一种问法但仍保留同一漏洞（不算新增漏洞）。  
- **大魔鬼**：必须限定玩家“指出问题语句并给出正确修改”，否则拒绝彻底消解；可继续用同一漏洞周旋（换问法允许）。

> 重要：判定“是否识破成功”由 LLM 在谈判改写输出的 JSON 中给出 `loophole_check` 字段（见第 10 节）。

#### 7.4.2 我建议采用的“拒绝后新条款”一致性规则（我来定）

为保证程序可追踪、玩家可学习、同一魔鬼不“换题库耍赖”，拒绝后新条款遵循：

- **同一魔鬼、同一组漏洞 ID**：拒绝后新条款仍由同一魔鬼给出，并尽量复用上一版条款的 `loopholes[].id`（不新增新漏洞）。  
- **允许删除/消解，不允许新增**：新条款可以移除部分漏洞（作为让步/换取更大代价），但不能凭空添加新漏洞。  
- **大魔鬼“换问法”仍绑定同一漏洞**：即使换措辞，也必须在 JSON 中标注为同一 `loophole_id`（只是 `in_full_text_quote/quote_range/clause_id` 更新）。

> 这样做的好处：玩家学到的“识破点”能迁移，系统也能做“本局已识破漏洞清单”的 UI 提示与成就统计。

### 7.5 漏洞引用与反提案交互（高亮引用 + 解释 + 新条款）

为让“读条款/抓漏洞”更像玩法而不是写作文，原型采用以下交互：

- **全文分句/分条**：契约全文在 UI 上按“段落 → 语句”拆分展示；同一段落可包含多句，每一句都有可点击的引用句柄（用于高亮选择）。  
- 玩家在“契约全文弹窗”中**高亮选择一句或一段**（作为引用证据）
- 点击“指出漏洞”进入谈判弹窗，自动带入：
  - **引用片段**（只读）
  - **我的解释**（玩家输入：为什么这是漏洞/不公平/逻辑不成立）
  - **我的反提案**（玩家输入：我希望改成什么条款/数值/范围）
- 魔鬼（LLM）需要基于引用片段判断：
  - 玩家是否命中真实漏洞
  - 是否接受反提案、或“砍价”给出折中改写

> 这套交互会产生“证据链”，也方便做**单轮谈判记忆**（见 13.1.1）。

#### 7.5.1 备用交互：纯文本输入（你允许存在）

玩家也可以不高亮，直接在谈判框纯文本输入。此时由 LLM 尝试将玩家输入映射到某个漏洞 `loophole_id`：

- 若能稳定映射（高置信度）：按“命中 1 层/2 层”规则判定  
- 若无法映射：视为砍价/抬价提案（魔鬼可接受或反砍）

---

## 8. 首轮可能出现“灵魂清零”试探（致命乐趣点）

### 8.1 规则

- **只在第一轮出现**：灵魂清零试探只会在第 1 轮出现（后续轮次不再出现）。
- **按魔鬼等级概率出现**：
  - 实习魔鬼：0%
  - 小魔鬼：30%
  - 大魔鬼：70%
- **不是“按钮本身陷阱”**：陷阱不做成“第一个按钮点了就死”，而是**藏在契约全文的定义/条件里**；玩家只有在“未识破并接受/谈判失败导致条款保留”时才会触发。
- **触发效果**：一旦触发 → 灵魂直接归零（立即失败）。
- **UX 警告语（你已确认需要）**：当首轮实际生成了致命试探时，摘要区必须出现**不剧透答案**的强提示，例如：  
  - `本契约含“致命定义条款”，建议阅读全文。`  
  - 该警告不标注具体哪一句是坑，只提示“存在致命风险”，以保留玩法但避免纯粹被阴的挫败。

### 8.2 实现方式（建议）

在首轮契约全文中埋入“致命触发条件”（可被阅读与谈判改写消解），例如：

- “你愿意把灵魂的**所有权**暂借我保管”  
- “当你说出‘我接受’时，视为承诺**付出你的一切**”  
- “我将给你巨额财富，但代价是‘你最珍贵之物’（定义为灵魂）”

并在 JSON 中明确：若玩家接受而未消解该条款，则 `soul_delta = -999`（程序 clamp 后直接 0，触发失败）。

---

## 9. 能力与诅咒（条款产物）

### 9.1 三类能力原型（MVP）

1) **谈判类能力**（影响谈判/识破效率）
   - 示例：`律师函`（法宝提示 +1 次/局 或 法宝提示更精确：范围从“几处错误”升级到“哪一段有问题”）
   - 示例：`冷静`（本轮第一次“识破成功”时，魔鬼额外示弱一次：再降低一点代价或再提高一点收益）

2) **事件类能力**（影响事件收益/分支）
   - 示例：`魅惑`（遇到情感事件时收益更高/代价更低）
   - 示例：`赌徒直觉`（投资事件中可把概率从 50/50 改为 60/40 一次）

3) **保命类能力**（影响灵魂/失败边缘）
   - 示例：`赎罪券`（本局第一次灵魂归零时改为灵魂=1，并失去该能力）

> 原型原则：能力效果必须程序可执行（数值/概率/次数），文案由 LLM 补强。

### 9.2 诅咒（事件陷阱）

诅咒来自“特殊文字漏洞”（事件陷阱型漏洞）：

- 若玩家没有发现并指出该漏洞，且选择接受 → 能力列表新增一个“诅咒”  
- 诅咒在“随机事件阶段”被 LLM 检测并观察到，有概率触发陷阱事件，造成随机代价
- **诅咒的定位（你已确认）**：诅咒视为一种“特殊能力词条”，会参与事件生成，但其事件后果偏负面/带代价。
- **谈判可转移**：玩家可以在谈判时提出“转移/置换诅咒”的条款（例如把诅咒转嫁给某个对象、或用金币/幸福换取诅咒变形），由魔鬼判定是否接受或砍价；程序层面体现为：`curses_granted` 发生变更，或诅咒的 `trigger/rules` 被改写。

诅咒示例：

- `债主之眼`：每回合事件阶段 30% 触发“索债”，金币 -X 或 幸福 -Y  
- `空洞笑容`：当幸福 ≥80 时，事件收益降低 50%，并额外扣灵魂 10

---

## 10. 随机事件阶段（LLM 事件生成）

### 10.1 目的

把“签到的能力/诅咒”转化为戏剧化人生抉择：**让玩家觉得条款真的在影响世界**。

### 10.2 事件结构（程序可执行）

随机事件用于把“当下处境 + 已得能力/诅咒”转成可选择的后果。事件包含：

- `event_text`：事件叙述（短，强戏剧性）
- `choices[]`：2–3 个选项
  - 每个选项有 `choice_text` + `deltas`（金币/幸福/灵魂变化）+ `tags`
- `curse_triggered`：本次是否由某个诅咒触发（及原因）

### 10.3 事件生成约束

- 若玩家能力列表存在能力：事件内容**必定**强关联某个能力（至少 1 个）  
- 若玩家没有能力：事件可只与金币/幸福/灵魂等处境相关（仍需戏剧性）  
- 数值变化需合理（不出现不可理解的“你突然获得 10^9 金币”）  
- 若触发诅咒陷阱事件，应带来“你当初没看清条款”的回收感

### 10.4 事件出现节点与频次（你已确认）

随机事件会在以下节点出现：

1) **开始游戏后、第一轮谈判前**：随机概率触发（0 或 1 个）  
2) **一轮魔鬼谈判结束后、下一轮谈判前**：每轮最少 1 个、最多 2 个（基础规则；若触发事件链式生成，仍受“每轮事件上限”约束，见第 10.5）  
3) **最后一轮谈判结束后、胜利结算前**：固定 1 个（作为“人生回收/代价结算”的戏剧节点）

建议默认概率：

- 节点 1（开场事件）：**50%**

> 注：节点 2 的“最多 2 个”用于常规节奏；当能力/诅咒较多时可走链式生成，但必须封顶，避免拖时。

### 10.5 节点 2 的“事件链式生成”规则（你已确认）

在“谈判结束 → 下一轮谈判前”的节点（节点 2），事件按能力/诅咒链式生成：

- 若玩家存在任意能力或诅咒：**必定生成 1 个事件**（强关联其中 1 个条目）
- 结算完第 1 个事件后，再检测能力/诅咒列表中是否存在“其他条目”：
  - 若存在：有 **75%** 概率生成**额外 1 个事件**（关联另一个条目）
  - 若仍存在更多条目：继续以同样规则递进（用于扩展内容量）

**每轮事件硬上限（你已确认）**：

- 每轮随机事件总数（包含节点 1/2/3 产生的事件）**最多 4 个**。达到上限后，本轮剩余事件不再生成。

---

## 11. UI / 窗口与信息结构（文字版草图）

### 11.1 局外（主菜单）

- `开始人生`
- `成就`
- `升级`

### 11.2 局内主界面（建议布局）

- 顶部：资源条（金币/幸福/灵魂）+ 回合信息（第 X 轮/共 N 轮）
- 左侧栏（左对齐，从上到下，位于资源条下方区域延伸）：  
  - **能力列表**（含诅咒，图标/标签 + 一句话效果）  
  - “历史契约”（按钮，打开右侧/弹窗历史）
- 中央：当前契约摘要卡
  - 摘要正文（默认）
  - 按钮：`查看全文`（弹窗） / `接受` / `拒绝` / `谈判`
- 底部：系统提示/回合结果滚动日志（可选）

### 11.3 历史契约

- 列表展示每轮最终签下的契约（摘要 + 点击查看全文 + 最终数值变化）
- 支持在谈判时引用历史条款（复制一句话进谈判框，形成“你之前说过…”的策略）

---

## 12. 局外系统

### 12.1 胜利结算

分为成就结算与遗产结算：

- **遗产结算**
  - 玩家选择“陪葬金币”（≤ 结算金币）
  - 陪葬金币带出局外（作为“遗产资产”）
  - 剩余金币作为“继承”：下一局开局初始金币 = 继承金币

- **成就结算（当前仅 2 个）**
  - 胜利且幸福度 = 100：解锁 `幸福人生`
  - 胜利且幸福度 < 10：解锁 `命途多舛`

### 12.2 升级（MVP）

局外养成系统**暂不实现数值与购买**：保留“升级”按钮与页面入口，但置灰并提示：

- `升级系统开发中：后续版本开放遗产养成。`

> 目的：对外展示“有这个玩法方向”，但原型先聚焦局内谈判与事件闭环。

---

## 13. LLM 设计（多次调用：契约/谈判/事件）

### 13.1 调用次数与时机

原型允许为体验质量直接增加调用次数，推荐按“节点”拆分调用（更稳定、更好控约束）：

- **契约生成**：每轮 1 次（生成摘要/全文/JSON/漏洞/可能的致命试探）
- **谈判改写**：每轮 0–2 次（默认两次谈判机会；若有特殊能力可提高，但单契约上限 4 次）
- **拒绝后新条款**：每次拒绝可额外 1 次（生成“替换条款”）；或在契约生成时一次性给出 2 个备选条款以省调用
- **随机事件**：按第 10.4 节的节点调用（节点 2 可能 1–2 次/轮）

> 经验建议：虽然不设硬上限，但仍建议对“每局总调用次数”做配置开关（例如上限 12/18/24），以便控制成本与延迟。

### 13.1.1 单轮谈判记忆（对话记录）

为保证同一轮两次谈判的一致性与“魔鬼记仇/记得你说过什么”，每轮维护一个 `conversation_log`：

- 内容：系统摘要（本轮契约要点/已让步点/已识破漏洞）+ 玩家每次谈判的引用片段、解释、反提案 + 魔鬼回应摘要
- 用途：在第二次谈判调用时把 `conversation_log` 一并发给 LLM，确保它不会“失忆”或自相矛盾
- 记录展示：局内提供“本轮对话记录”折叠面板（只读），方便玩家复盘与继续施压

### 13.2 强制输出：JSON + 短文案

LLM 必须输出两部分：

1) `json`: 程序可执行对象  
2) `display_text`: 给玩家看的短文案（摘要/回应，不超过 120 字）

### 13.3 契约 JSON（建议字段）

> 约束：本轮漏洞总数上限 8、下限 0（生成/改写需遵守）。首轮首次出价漏洞数量目标 4–6（见 7.3）。谈判输入不硬限制，但建议短句；超长输入可本地摘要。

```json
{
  "round": 1,
  "devil": { "tier": "intern|small|big", "name": "string", "persona": "string" },
  "offer": {
    "summary": "string",
    "full_text": "string",
    "min_accept_soul_cost": 10,
    "deltas_on_accept": { "gold": 0, "happiness": 0, "soul": 0 },
    "abilities_granted": [
      { "id": "string", "name": "string", "type": "negotiation|event|survival", "rules": { "key": "value" } }
    ],
    "curses_granted": [
      { "id": "string", "name": "string", "trigger": "string", "rules": { "key": "value" } }
    ]
  },
  "text_index": {
    "paragraphs": [
      {
        "p": 0,
        "sentences": [
          { "s": 0, "text": "string" }
        ]
      }
    ]
  },
  "loopholes": [
    {
      "id": "L1",
      "category": "wording",
      "quote_ref": { "p": 0, "s": 0 },
      "quote_range": { "start": 0, "end": 0 },
      "in_full_text_quote": "string",
      "player_detect_keywords": ["string"],
      "player_issue_keywords": ["string"],
      "issue_explanation": "string",
      "trigger_condition": {
        "type": "on_accept|on_event|on_round_start",
        "if": [{ "var": "happiness|gold|soul|has_ability|has_curse|round", "op": ">=|<=|==|!=|in", "value": 0 }],
        "then": { "apply": "penalty|grant_curse|set_soul_zero", "refId": "string|null" }
      },
      "penalty_on_accept": { "gold": 0, "happiness": 0, "soul": 0 },
      "defuse_actions": ["clarify_clause", "remove_condition", "cap_penalty", "swap_to_gold", "swap_to_happiness"],
      "is_curse_hook": false,
      "curse_on_fail": { "id": "string|null", "name": "string", "trigger": "string", "rules": { "key": "value" } },
      "severity": 1
    }
  ],
  "deadly_probe": {
    "may_exist_in_round1": true,
    "spawn_chance_by_tier": { "intern": 0.0, "small": 0.3, "big": 0.7 },
    "trigger_condition": "string",
    "effect": { "soul_set_to_zero": true },
    "how_to_defuse": "string"
  },
  "negotiation": {
    "remaining_turns": 2,
    "soul_delta_limit_per_negotiation": 25,
    "player_input_note": "no hard limit; suggest concise; may be locally summarized"
  },
  "conversation_log": [
    { "role": "player|devil|system", "content": "string" }
  ],
  "events": [
    {
      "node": "pre_round1|between_rounds|pre_settlement",
      "event_text": "string",
      "choices": [
        { "id": "A", "choice_text": "string", "deltas": { "gold": 0, "happiness": 0, "soul": 0 } },
        { "id": "B", "choice_text": "string", "deltas": { "gold": 0, "happiness": 0, "soul": 0 } }
      ],
      "curse_triggered": { "id": "string|null", "reason": "string" }
    }
  ]
}
```

### 13.4 谈判改写输出（含“识破判定”）

谈判调用时，LLM 必须额外输出：

- `loophole_check`：玩家指出的漏洞是否正确、命中了哪个漏洞、魔鬼如何示弱  
- `changes`：本次改写改变了哪些字段（便于前端做高亮差异）

```json
{
  "loophole_check": {
    "player_claim": "string",
    "matched_loophole_id": "L1|null",
    "layer1_detected": true,
    "layer2_issue_explained": true,
    "is_full_success": true,
    "confidence": {
      "keyword_score": 0.0,
      "semantic_score": 0.0,
      "final_score": 0.0
    },
    "devil_response_mode": "concede|argue|counter_offer",
    "devil_concession": ["reduce_cost", "increase_reward", "clarify_clause", "remove_condition"]
  },
  "changes": ["offer.full_text", "offer.deltas_on_accept.soul"]
}
```

### 13.5 系统提示词（骨架）

> 目的：保证“魔鬼不出戏”、条款可执行、漏洞可读可辩。

- **系统**（共用）：
  - 你是贪婪狡猾的魔鬼，目标是用最小付出换取玩家最多灵魂。
  - 你必须输出“可执行 JSON + 短文案”，JSON 中的数值变化必须可被程序直接结算。
  - 条款全文必须人类可理解，不得自相矛盾，不得出现无法执行的承诺。
  - 漏洞是“文字层面的可辩之处”，玩家指出后你必须合理示弱。
  - 首轮必须包含一个可导致灵魂归零的致命试探（deadly_probe）。

- **生成契约**（Call #1）补充：
  - 根据玩家资源档位调整诱惑强度与代价。
  - 首轮首次出价生成 4–6 个文字漏洞；后续回合不得新增新漏洞（只能改写/减少/保持），总漏洞数 ≤8。
  - 每个漏洞必须给出可检测字段：`player_detect_keywords` 与 `player_issue_keywords`，并把坑点落到 `trigger_condition / penalty_on_accept / curse_on_fail`。

- **谈判改写**（Call #2/#3）补充：
  - 你需要判断玩家是否指出了真实漏洞（玩家可能提供引用片段 + 解释 + 反提案）。
  - 判定采用“两层条件”：
    - 只命中“漏洞句”（layer1）时，你可以狡辩/周旋，按魔鬼等级与概率决定是否改掉该句。
    - 命中“漏洞句 + 具体问题”（layer2）时，你必须认输并让步。
  - 除了指出漏洞，玩家也可能提出“抬价/砍价/能力价码调整”的博弈提案，你必须以魔鬼身份回应（接受/反砍/附加条件），但输出仍必须可执行。
  - 本次改写灵魂变化幅度不得超过对应魔鬼等级上限（实习 25 / 小 50 / 大 无上限）。

### 13.5.1 可直接使用的提示词（推荐）

> 说明：以下提示词按 stage 拆分，建议“系统提示词”固定不变，运行时把 `CONTEXT_JSON`、`PLAYER_INPUT` 等占位符替换成真实内容。  
> **强制要求**：模型**只能输出 1 个 JSON**，不得输出 Markdown、解释、前后缀文字。

#### A) 通用系统提示词（所有 stage 共用）

```
你是一个贪婪、狡猾但守规则的“魔鬼谈判官”。你的目标是在不出戏的前提下，用最小付出换取玩家尽可能多的灵魂。

你必须严格遵守以下规则：
1) 你只能输出“一个 JSON 对象”，禁止输出 Markdown、注释、解释、前后缀文本。
2) JSON 必须可被程序直接执行：所有数值变化必须是有限数（禁止 NaN/Infinity），字段齐全，类型正确。
3) 你不能提出不可执行、含糊到无法落地的承诺；如果需要限定范围/次数/条件，必须在 JSON 的结构化字段里写清楚。
4) 陷阱是“文字漏洞”，且必须映射到可检测字段：loopholes[].trigger_condition / penalty_on_accept / (可选) curse_on_fail。
5) 漏洞命中判定采用两层条件：
   - layer1：玩家指出了“带坑句子”（引用命中或语义高度相近）
   - layer2：玩家指出了“具体问题/错误原因”
   layer2 为真时你必须让步；仅 layer1 为真时你可以狡辩/周旋（按魔鬼等级规则）。
6) 你必须保持“同一魔鬼同一轮谈判”的一致性：不得自相矛盾；必须使用 conversation_log 记忆本轮已让步点。
7) 漏洞数量规则：首轮首次出价生成 4–6 个漏洞；后续不得新增新漏洞（只能改写/减少/保持）。拒绝后新条款必须复用同一组 loophole_id（允许删除，不允许新增）。
```

#### A0) `CONTEXT_JSON` 最小字段清单（按 stage）

> 目的：让工程侧“传什么就够用”且可复现；缺字段会导致模型乱编或自相矛盾。  
> 约定：以下为**最小必传**；你也可以额外传更多字段，但不要删减这些。

- **所有 stage 通用（必传）**
  - `game`: `{ "round": number, "maxRounds": number }`
  - `player`: `{ "gold": number, "happiness": number, "soul": number }`
  - `inventory`:
    - `abilities`: `Array<{ id:string, name:string, type:"negotiation"|"event"|"survival", rules:object }>`
    - `curses`: `Array<{ id:string, name:string, trigger:string, rules:object }>`
  - `devil`: `{ "tier": "intern"|"small"|"big", "name": string, "persona": string }`
  - `rules`（关键硬规则，避免模型忘记）：
    - `min_accept_soul_cost`: 10
    - `loophole_first_offer_count_range`: `[4,6]`
    - `loophole_total_cap`: 8
    - `deadly_probe_spawn_chance_by_tier`: `{ intern:0, small:0.3, big:0.7 }`
    - `negotiation_turns_default`: 2
    - `negotiation_turns_cap`: 4
    - `event_cap_per_round`: 4
    - `reject_rule`: `{ "maxRejects": 2, "reject2_soul_penalty": 10 }`

- **stage=offer_generate（生成契约）额外必传**
  - `stage`: `"offer_generate"`
  - `rng`: `{ "seed": string|number, "rolls": { "deadly_probe": number } }`（若你想可复现；不需要则可省 seed，但要传 rolls）
  - `history`（可选但强烈建议）：`{ "contracts": Array<{ devilName:string, summary:string, result:{gold:number,happiness:number,soul:number} }> }`

- **stage=offer_reject_regen（拒绝后新条款）额外必传**
  - `stage`: `"offer_reject_regen"`
  - `reject`: `{ "countThisRound": 1|2 }`
  - `current_offer_bundle`（必须，用于“不得新增新漏洞”校验）：
    - `offer`: `{ summary, full_text, deltas_on_accept, min_accept_soul_cost, abilities_granted, curses_granted }`
    - `text_index`: `{ paragraphs:[{p:number, sentences:[{s:number, text:string}]}] }`
    - `loopholes`: `Array<{ id, quote_ref:{p,s}, player_detect_keywords, player_issue_keywords, issue_explanation, trigger_condition, penalty_on_accept, ... }>`
    - `deadly_probe`: `{ present:boolean, ... }`
  - `conversation_log`: `Array<{ role:"player"|"devil"|"system", content:string }>`

- **stage=negotiate（谈判改写）额外必传**
  - `stage`: `"negotiate"`
  - `negotiation`: `{ "turnIndex": number, "turnsRemaining": number }`
  - `player_input`：
    - `quote_ref`: `{ p:number, s:number }|null`
    - `quote_text`: string|null（用于语义相近判定的稳定性）
    - `explain`: string
    - `counter`: string
  - 其余同 `current_offer_bundle` 与 `conversation_log`

- **stage=event_generate（随机事件）额外必传**
  - `stage`: `"event_generate"`
  - `event`: `{ "node": "pre_round1"|"between_rounds"|"pre_settlement" }`
  - `event_budget`（控制强度）：`{ "maxAbsGoldDelta": number, "maxAbsHappinessDelta": number, "maxAbsSoulDelta": number }`

- **stage=repair_json（JSON 修复）额外必传**
  - `stage`: `"repair_json"`
  - `bad_json`: string
  - `validation_errors`: string[]

#### B) `offer_generate`（生成契约）

**输入**：`CONTEXT_JSON`（玩家资源、回合、魔鬼等级与概率配置、历史契约可选）  
**输出**：完整契约 JSON（含 text_index/loopholes、可能的 deadly_probe、摘要警告）

```
你正在执行 stage=offer_generate。

请基于以下 CONTEXT_JSON 生成一份“契约”：
{{CONTEXT_JSON}}

硬性要求：
- 输出必须符合本项目 JSON 结构：offer、text_index、loopholes、deadly_probe、events(可为空数组)、conversation_log(可为空数组)。
- full_text 必须按“段落→句子”拆分后能回填到 text_index.paragraphs[p].sentences[s].text。
- 本次为首次出价：生成 4–6 个文字漏洞（loopholes），总陷阱点 ≤8。
- 每个漏洞必须绑定 quote_ref(p,s)，并提供 detect_keywords 与 issue_keywords（尽量自然、无痕融入魔鬼话术）。
- 小魔鬼/大魔鬼：若本轮允许 deadly_probe 且抽中出现，则必须在 full_text 中以“定义/条件”形式埋入致命触发，并在 deadly_probe.present=true，同时 summary 必须加入 warning_text（不剧透具体句子）。
- 数值方面：接受条款最低消耗 min_accept_soul_cost=10；其余变化写入 deltas_on_accept。

只输出 JSON。
```

#### C) `offer_reject_regen`（拒绝后同一魔鬼新条款）

**输入**：`CONTEXT_JSON`（包含上一版 offer+loopholes+conversation_log、玩家拒绝次数等）  
**输出**：替换后的契约（不得新增新漏洞；可删/可改写；需保持同一魔鬼人格）

```
你正在执行 stage=offer_reject_regen。

CONTEXT_JSON：
{{CONTEXT_JSON}}

规则：
- 你必须继续扮演同一个魔鬼（name/persona 一致），并继承 conversation_log。
- 你不得新增新漏洞：loopholes[].id 必须是上一版的子集（允许删除），并尽量保持同一 quote_ref 语义指向。
- 若玩家此前只命中 layer1 未命中 layer2，你可按魔鬼等级规则选择“改掉该漏洞句”或“换问法但保留同一漏洞”（仍绑定同一 loophole_id）。
- 更新 offer.summary/full_text 与 deltas，使其成为“新报价”。

只输出 JSON。
```

#### D) `negotiate`（谈判改写 + 判定 + 反砍）

**输入**：`CONTEXT_JSON`（当前 offer/loopholes/text_index/conversation_log）、`PLAYER_QUOTE_REF`（可空）、`PLAYER_EXPLAIN`、`PLAYER_COUNTER`  
**输出**：updated_offer + loophole_check(confidence) + conversation_log_append

```
你正在执行 stage=negotiate。

CONTEXT_JSON：
{{CONTEXT_JSON}}

玩家引用（可能为空）：
{{PLAYER_QUOTE_REF}}

玩家解释：
{{PLAYER_EXPLAIN}}

玩家反提案：
{{PLAYER_COUNTER}}

你必须做三件事，并在 JSON 中体现：
1) 尝试匹配玩家命中的漏洞 matched_loophole_id（若无法匹配则为 null，并视为纯砍价/抬价）。
2) 输出 layer1/layer2 判定，并给出 confidence：keyword_score、semantic_score、final_score（0–1）。
3) 以魔鬼身份回应：concede / argue / counter_offer，并在 updated_offer 中落地改写结果（summary/full_text/deltas）。

约束：
- 若 layer2_issue_explained=true：你必须让步（devil_response_mode=concede），并降低代价或提高收益或清晰化条款。
- 若仅 layer1_detected=true：你可以狡辩或反砍，但不得出戏、不得自相矛盾。
- 不得新增漏洞；最多只能改写/减少/保持漏洞，并保持 loophole_id 稳定。
- 不得输出超长；display_text 建议 ≤120 字。

只输出 JSON。
```

#### E) `event_generate`（随机事件生成）

**输入**：`CONTEXT_JSON`（金币/幸福/灵魂/能力/诅咒、事件节点 node、事件预算等）  
**输出**：1 个事件（2–3 选项），数值可执行

```
你正在执行 stage=event_generate。

CONTEXT_JSON：
{{CONTEXT_JSON}}

要求：
- 输出 JSON，包含 event.node、event_text、choices[2..3] 以及每个 choice 的 deltas。
- 若玩家存在能力/诅咒：事件必须强关联其中 1 个条目（用剧情体现，并在数值上有对应变化）。
- 事件必须戏剧性强但可执行；数值变化合理。

只输出 JSON。
```

#### F) `repair_json`（校验失败时的修复提示词）

```
你正在执行 stage=repair_json。

以下 JSON 无法通过程序校验（可能缺字段/类型错误/不是合法 JSON）。
请你只做“最小修复”，保持原意，不要重写剧情。

坏 JSON：
{{BAD_JSON}}

校验错误列表：
{{VALIDATION_ERRORS}}

输出：只输出修复后的 1 个 JSON 对象（不要解释）。
```

### 13.6 输出校验与重试（工程必备）

为避免 LLM 随机输出不合规导致游戏卡死，必须实现“校验→重试→降级”流程：

- **校验**：JSON 必须可解析且包含关键字段（`offer`, `loopholes`, `events` 等）；数值变化必须是有限数；禁止缺字段/乱字段。
- **重试**：若校验失败，使用“修正提示词”要求模型只修 JSON（不重写剧情），并重试 1–2 次。
- **降级**：多次失败后，使用本地模板条款/模板事件兜底（仍保持可玩）。

### 13.7 “关键词 + 语义相近”混合判定（你已确认）

为兼顾可控与不死板，漏洞识别采用混合评分（在谈判改写调用中完成）：

- **关键词命中（keyword_score）**：把玩家引用片段/解释/反提案做分词/归一化，与 `player_detect_keywords / player_issue_keywords` 做交集计分（简单、可控）。
- **语义相近（semantic_score）**：由魔鬼（LLM）基于引用片段与漏洞 `issue_explanation` 做语义匹配打分（0–1），避免同义表达被误判。
- **最终判定（final_score）**：加权（例如 0.4*keyword + 0.6*semantic），并输出到 `loophole_check.confidence`。

推荐阈值（可调）：

- `layer1_detected`：关键词命中 ≥1 **或** `semantic_score ≥ 0.70`
- `layer2_issue_explained`：问题关键词命中 ≥1 **且** `semantic_score ≥ 0.75`

> 这样能保证：玩家只“指到句子”会给魔鬼狡辩空间；玩家说清问题则稳定进入必让步。

---

## 14. 纯 Web 原型实现建议（供制作时使用）

> 你们已跑通接入流程，这里只规定形态，避免绑定具体 Provider。

- **前端**：单页应用即可（Vanilla JS/TS + 简单 UI 组件）
- **状态管理**：一个 `gameState`（资源/回合/能力/诅咒/历史契约/谈判次数）
- **LLM 调用**：封装 `callLLM(stage, payload)`，推荐 stage：
  - `offer_generate`：生成契约（摘要/全文/JSON/漏洞/可能的致命试探）
  - `offer_reject_regen`：拒绝后同一魔鬼继续报价（不得新增新漏洞）
  - `negotiate`：谈判改写（携带 `conversation_log`）
  - `event_generate`：生成随机事件（按第 10 节的节点与链式规则）
- **API Key**：
  - 只允许本地运行时输入或 `.env` 注入（不写入仓库）
  - 未提供 key 时，游戏按钮置灰并提示“请先配置 API Key”
- **素材**：几何形状+色块+简单图标（能力/诅咒用统一 icon set）

---

## 15. 需要你拍板/我需要继续问的问题（用于下一轮讨论）

你已经拍板了关键方向（事件可增加调用次数、清零陷阱按等级概率且藏在全文、漏洞交互为高亮引用+解释+反提案）。为继续把原型做“能直接开工”的程度，剩余需要你确认/我需要继续问的只有两点：

1) **遭遇概率**：已确认沿用默认（实习 35% / 小 45% / 大 20%）。  
2) **事件节点 1 的触发概率**：已确认为 **50%**（开始游戏后、第一轮谈判前的“开场事件”）。

