# 小村庄领主（Village Lord）—— 最小玩法原型策划案

> **文档性质**：可直接开工的 MVP 原型策划案
> **技术路线**：纯 Web（H5），PC 浏览器优先
> **目标**：用最低成本验证"LLM 驱动的 NPC 涌现行为是否有趣"
> **日期**：2026-02-09
> **版本**：v0.2（经模拟反思修订）

---

## 一、一句话概念

**你是中世纪小村庄的领主，管理 6 个有独立性格和记忆的 AI 村民——你做决策，他们自己"活着"，你观察涌现出的故事，再做下一步决策。存活 7 天，书写一段独一无二的村庄编年史。**

---

## 二、核心卖点（3 条）

1. **活的村民**：每个村民由 LLM 驱动，拥有完整的认知链（观察→记忆→评估→反思→行动）——他们会合作、争吵、背叛、恋爱，行为不可预测但合理。
2. **间接控制的策略感**：你不能命令任何人，只能通过"颁布政策"和"与村民交谈"间接影响一切——像下棋，但棋子有自己的想法。
3. **每局都是新故事**：没有预设剧本，6 个性格迥异的村民在你的决策下涌现出独一无二的 7 天编年史。

---

## 三、核心循环（6 步闭环）

```
┌─────────────────────────────────────────────────────────────────┐
│                        每一"天"的循环                             │
│                                                                 │
│  ① 阅读晨报                                                     │
│     └─ 昨日发生了什么？村民日志、状态变化、关系变动、事件提示        │
│     └─（第 1 天特殊：显示"村庄概况"介绍 6 位村民）                 │
│                              ↓                                  │
│  ② 玩家决策（每天 1~2 次操作）                                    │
│     ├─ 操作 A：颁布政策（从 3~4 个选项中选一个，可选"不颁布"）     │
│     └─ 操作 B：与一名村民交谈（选村民 + 选话题/语气，可跳过）      │
│     └─ 点击"结束今天"前弹出确认（防误操作）                       │
│                              ↓                                  │
│  ③ 系统打包上下文 → JSON                                        │
│     ├─ 世界状态快照（资源/天气/危机）                              │
│     ├─ 全体村民档案（性格/记忆/关系/情绪/健康/忠诚）               │
│     └─ 玩家本回合决策                                            │
│                              ↓                                  │
│  ④ LLM 处理（2 次 API 调用）                                    │
│     └─ 全体村民经"观察→记忆→评估→反思→行动"认知链输出行动         │
│                              ↓                                  │
│  ⑤ 程序化校验 + 状态更新                                        │
│     ├─ 白名单校验（动作/目标是否合法）                             │
│     ├─ 查效果表：action × intensity → 数值变化（程序计算，非LLM）  │
│     ├─ 更新：资源、关系、情绪、健康、忠诚、事件队列                 │
│     ├─ 自动存档到 localStorage                                   │
│     └─ 生成当日报告文本                                          │
│                              ↓                                  │
│  ⑥ 结算检查                                                     │
│     ├─ 是否触发失败条件？→ 结局                                   │
│     ├─ 是否第 7 天结束？→ 生成编年史 → 结局                       │
│     └─ 否 → 天数 +1 → 回到 ①                                    │
└─────────────────────────────────────────────────────────────────┘
```

**关键节奏**：
- 第 1~2 天：新手期，简单决策，认识村民
- 第 3~4 天：矛盾浮现，内部冲突开始
- 第 5~6 天：外部危机 + 内部矛盾叠加，高压决策
- 第 7 天：终局结算

---

## 四、LLM 交互设计

### 4.1 NPC 认知架构：观察—记忆—评估—反思—行动

每个村民的行为决策遵循 **OMERA 认知链**（Observe → Memory → Evaluate → Reflect → Act），这是本游戏的核心 AI 设计：

```
┌──────────────────────────────────────────────────────────┐
│  OMERA 认知链（每个村民每天执行一次）                       │
│                                                          │
│  ① 观察（Observe）                                       │
│     └─ 感知世界状态：资源、天气、领主政策、其他村民的行为     │
│                                                          │
│  ② 记忆（Memory）                                        │
│     └─ 回溯近期经历：最近 3~5 条关键事件记忆               │
│                                                          │
│  ③ 评估（Evaluate）                                      │
│     └─ 基于性格解读：用自己的性格标签过滤信息               │
│        例：勤劳的人看到芬恩偷懒 → 评估为"不可接受"         │
│        例：懒散的人看到同样场景 → 评估为"也没什么大不了"     │
│                                                          │
│  ④ 反思（Reflect）                                       │
│     └─ 内心独白：产生情绪反应、形成意图、权衡利弊           │
│        这一步的输出 = 玩家看到的"内心想法"                  │
│                                                          │
│  ⑤ 行动（Act）                                           │
│     └─ 选择动作 + 目标 + 强度                             │
│        action 从白名单选，intensity 从 low/medium/high 选  │
│        diary = 用第三人称描述今天做了什么                   │
└──────────────────────────────────────────────────────────┘
```

**设计意义**：
- 让 LLM 进行**链式思考**（Chain-of-Thought），决策质量远高于直接输出 action
- 每一步的输出对玩家都有展示价值（observe/reflect → 展示在村民详情里）
- 数值变化由**程序查表计算**（根据 action + intensity），而非 LLM 输出数字，**确保平衡可控**

### 4.2 玩家输入形态

玩家**不直接与 LLM 对话**。玩家通过 UI 选择操作，系统将操作翻译为 LLM 上下文的一部分。

| 操作类型 | 输入形式 | 示例 |
|---------|---------|------|
| 颁布政策 | 从预设选项中点选（含"不颁布"） | "全力采集食物" / "篝火晚会" / "自由行动" |
| 与村民交谈 | 选村民 → 选话题/语气（可跳过） | 选"猎人艾拉" → 选"鼓励" |
| 结束当天 | 点击"进入下一天" → 确认弹窗 | "确定结束今天？政策：全力采食 / 交谈：鼓励赫尔曼" |

### 4.3 系统提示词（System Prompt）

```
你是一个中世纪村庄模拟引擎。你的任务是：根据给定的村民档案和世界状态，为每个村民执行一次完整的认知决策链，并输出行动结果。

## 你的角色
你不是在和任何人对话。你是一个行为决策引擎。对每个村民，你必须按照"观察→记忆→评估→反思→行动"的顺序进行思考，然后输出结构化 JSON。

## 认知链说明
对每个村民，你必须依次完成：
1. **observe**（观察）：该村民能感知到什么？世界状态、领主政策、其他人的行为
2. **remember**（记忆）：该村民回忆起什么？与当前情境相关的近期经历
3. **evaluate**（评估）：基于性格，如何解读这些信息？（不同性格的人看同一件事有不同评价）
4. **reflect**（反思）：内心独白——情绪反应、意图形成（这会被展示给玩家）
5. **action + target + intensity**（行动）：最终决定做什么、对谁、多用力
6. **diary**（日志）：用第三人称简短描述这一天做了什么

## 输出规则（必须严格遵守）
1. 必须以纯 JSON 数组格式输出，不添加任何其他文字
2. 数组内每个对象对应一个村民，必须包含 villager_id
3. action 必须从白名单中选择，不可自创
4. intensity 必须为 "low"、"medium"、"high" 三选一
5. observe / remember / evaluate / reflect 各字段 ≤ 60 字
6. diary 必须用第三人称、简体中文，≤ 80 字，生动但简洁
7. 行动必须符合该村民的性格特征——不同性格对同一局面应有不同反应
8. 必须考虑该村民与其他村民的关系——亲近则互动，敌对则冲突
9. 必须考虑领主的最新政策——但村民不一定服从，取决于忠诚度和性格

## 白名单动作
- work_food：采集食物（产出食物）
- work_wood：砍伐木材（产出木材）
- work_gold：赚取金币（产出金币）
- rest：休息（恢复健康和心情，但无产出）
- socialize：与某村民友好社交（需指定 target）
- argue：与某村民争吵（需指定 target）
- help：帮助某村民（需指定 target，消耗自身精力）
- steal：偷窃公共资源（有被发现风险）
- plead：向领主求助（触发事件提示）
- prepare_flee：准备出走（忠诚极低时才合理）

## 禁止事项
- 不可杀死或移除任何村民
- 不可创造不存在的资源或物品
- 不可修改其他村民的性格
- 不可破坏第四面墙（不可提及"游戏""AI""玩家"等概念）
```

### 4.4 结构化输出 JSON 契约

#### Schema

```json
{
  "villager_id": "string  // 必填，村民ID（herman/ella/martha/tom/finn/ada）",
  "observe": "string  // 该村民观察到了什么，≤60字",
  "remember": "string  // 该村民回忆起了什么，≤60字",
  "evaluate": "string  // 基于性格的评估/解读，≤60字",
  "reflect": "string  // 内心独白（展示给玩家的'内心想法'），≤60字",
  "action": "string  // 必须从白名单枚举中选择",
  "target": "string | null  // 社交/争吵/帮助类动作的目标村民ID，其他为null",
  "intensity": "string  // 'low' | 'medium' | 'high'",
  "diary": "string  // 第三人称日志，≤80字，简体中文"
}
```

#### 示例输出（完整 6 人）

```json
[
  {
    "villager_id": "herman",
    "observe": "领主下令全力采食物。芬恩又靠在树下弹琴，完全没有干活的意思。",
    "remember": "昨天领主专门来鼓励我，说我是村庄的顶梁柱。",
    "evaluate": "领主是个有远见的人，知道食物才是命根子。但芬恩这个废物迟早拖垮全村。",
    "reflect": "先不管芬恩了，领主看得到我的付出，我要更加卖力才行。",
    "action": "work_food",
    "target": null,
    "intensity": "high",
    "diary": "赫尔曼天没亮就扛着锄头出了门，一个人干了三个人的活。回来时累得腰都直不起来，但扛回的粮食堆得老高。"
  },
  {
    "villager_id": "finn",
    "observe": "领主又在催大家干活了。赫尔曼一大早就出去了，真是个不懂享受的老头。",
    "remember": "前天赫尔曼当众骂我偷懒，太伤自尊了。不过艾达倒是笑着听我弹琴。",
    "evaluate": "这种只知道干活的日子有什么意思？人活着不就图个开心吗。",
    "reflect": "今天才不要干活呢。去找艾达聊聊天，她最近心情好像不太好。",
    "action": "socialize",
    "target": "ada",
    "intensity": "medium",
    "diary": "芬恩无视了领主的政策，端着他那把旧琴溜达到艾达门前，给她弹了一首欢快的小曲。艾达难得露出了笑容。"
  }
]
```

> 注：为节省篇幅只展示 2 人，实际输出为 6 人的完整数组。

### 4.5 效果查表（Action × Intensity → 数值变化）

**核心原则**：LLM 只输出行为决策（action + intensity），所有数值变化由程序根据下表计算。确保平衡 100% 可控。

#### 基础效果表（intensity = medium 的基准值）

| 动作 | 自身心情 | 自身健康 | 忠诚变化 | 目标关系 | 资源产出 | 特殊规则 |
|------|---------|---------|---------|---------|---------|---------|
| `work_food` | -4 | -4 | +2 | — | 食物 +8 | 受政策加成 |
| `work_wood` | -4 | -4 | +2 | — | 木材 +8 | 受政策加成 |
| `work_gold` | -3 | -3 | +2 | — | 金币 +4 | 受政策加成 |
| `rest` | +8 | +8 | -1 | — | — | — |
| `socialize` | +5 | 0 | 0 | +8 | — | 双方心情各 +3 |
| `argue` | -6 | 0 | -1 | -10 | — | 目标心情 -4 |
| `help` | +3 | -4 | +2 | +8 | — | 目标健康 +5 |
| `steal` | +5 | 0 | 0 | — | 食物 -4 | 见偷窃机制 |
| `plead` | -3 | 0 | +3 | — | — | 生成求助提示 |
| `prepare_flee` | -10 | 0 | -5 | — | — | 见出走机制 |

#### 强度倍率

| 强度 | 倍率 | 说明 |
|------|------|------|
| `low` | ×0.6（四舍五入） | 敷衍了事 / 轻微 |
| `medium` | ×1.0 | 正常力度 |
| `high` | ×1.5（四舍五入） | 全力以赴 / 激烈 |

> 示例：`work_food` + `high` → 食物产出 = 8 × 1.5 = +12，心情变化 = -4 × 1.5 = -6

#### 政策加成

当玩家颁布了与动作匹配的政策时，该类动作的**资源产出额外 +30%**（向上取整）：

| 政策 | 加成动作 |
|------|---------|
| `focus_food` | `work_food` 产出 +30% |
| `focus_wood` | `work_wood` 产出 +30% |
| `enforce_order` | 所有 `work_*` 产出 +20%，但全员心情额外 -3 |

### 4.6 偷窃机制（steal 特殊规则）

| 项 | 值 |
|----|-----|
| 公共资源减少 | 食物 -4 × 强度倍率（即 low:-2, medium:-4, high:-6） |
| 偷窃者心情 | +5 × 强度倍率 |
| 被发现概率 | 40%（low）/ 50%（medium）/ 65%（high） |
| 被发现后果 | 偷窃者忠诚 -15，与发现者关系 -20，全体村民与偷窃者关系 -5 |
| 发现者选择 | 优先：当天有 `socialize` 行为的村民 → 否则随机 |
| 未被发现 | 无额外后果，仅公共资源减少 |

### 4.7 出走机制（prepare_flee 详细流程）

```
┌─ 第 N 天：LLM 输出 prepare_flee
│   ├─ 村民 status → "preparing_flee"
│   ├─ 晨报提示："某某似乎在悄悄收拾行囊……"
│   └─ 忠诚额外 -5
│
├─ 玩家干预窗口（第 N+1 天的决策阶段）
│   ├─ 可选择与该村民交谈（警告 / 鼓励 / 赠礼）
│   ├─ 若干预后忠诚 ≥ 25 → 取消出走，status → "normal"
│   └─ 日志提示："在领主的挽留下，某某决定再留一段时间。"
│
└─ 第 N+1 天结算时
    ├─ 若忠诚仍 < 20 → 自动出走（无论 LLM 输出什么）
    │   ├─ status → "fled"
    │   ├─ 该村民从所有后续回合移除
    │   ├─ 其他村民心情各 -5（有人离开的失落感）
    │   └─ 日志："某某在夜色中悄然离去，只留下一封简短的告别信。"
    │
    └─ 若忠诚 ≥ 20 但 < 25 → LLM 重新评估（可能继续 prepare_flee 或改变主意）
```

### 4.8 LLM 调用策略（低成本优化）

| 策略 | 说明 |
|------|------|
| **批量处理** | 一次 API 调用处理全部 6 个村民，返回 JSON 数组 |
| **批量降级** | 若 6 人批量失败，拆成 2 组（3人/组）重试；仍失败则模板降级 |
| **上下文压缩** | 每个村民只发送：性格标签 + 最近 3 条记忆 + 关系数值 + 当前状态 |
| **调用次数** | 每天固定 2 次：①全体村民行动 ②（可选）编年史/特殊事件 |
| **Token 预算** | 输入 ≤ 1800 tokens，输出 ≤ 1200 tokens（含认知链），每天 ≤ 6000 tokens |
| **缓存模板** | 系统提示词不变部分缓存，只替换动态数据 |

**预估每局成本（7 天）**：约 14 次 API 调用，总计约 8.4 万 tokens。
- 豆包（doubao-1.5-pro-32k）：约 ¥0.15~0.4/局
- DeepSeek-chat：约 ¥0.08~0.2/局
- GPT-4o-mini：约 ¥0.4~1.0/局

> 比 v0.1 版本增加约 40% token 量（因认知链输出），但换来的决策质量提升是值得的。

### 4.9 解析 / 约束 / 降级策略

```
LLM 原始输出
     ↓
┌─ JSON 解析成功？
│   ├─ 是 → 进入逐村民校验
│   └─ 否 → 尝试提取 JSON 子串 → 仍失败 →
│           拆分为 2 组重试 → 仍失败 → 【降级】全体模板行为
│
对每个村民对象：
│
├─ villager_id 合法？
│   ├─ 是 → 继续
│   └─ 否 → 跳过该对象（该村民用模板行为）
│
├─ action 在白名单内？
│   ├─ 是 → 继续
│   └─ 否 → 【降级】替换为该村民的性格默认动作
│
├─ target 存在且合法？（仅 socialize/argue/help 需要）
│   ├─ 是 → 继续
│   ├─ 缺失但动作需要 → 【降级】随机选一个关系值最匹配的村民
│   └─ 动作不需要 target → 忽略
│
├─ intensity 合法？
│   ├─ 是 → 继续
│   └─ 否 → 【降级】默认 "medium"
│
├─ 认知链字段（observe/remember/evaluate/reflect）存在？
│   ├─ 是 → 截断到 60 字以内
│   └─ 否 → 留空（不影响数值计算，仅影响展示）
│
├─ diary 存在且 ≤ 80 字？
│   ├─ 是 → 继续
│   └─ 否 → 截断前 80 字 + "……" / 缺失则用模板日志
│
└─ 校验通过 → 查效果表计算数值 → 应用到游戏状态
```

**模板降级行为**（LLM 完全不可用时的兜底）：

| 村民 | 性格倾向 | 默认动作 | 默认强度 | 日志模板 |
|------|---------|---------|---------|---------|
| 赫尔曼 | 勤劳 | `work_food` / `work_wood`（轮替） | high | "{name}像往常一样埋头干活，没什么特别的。" |
| 艾拉 | 勇敢 | `work_wood` | medium | "{name}独自去了林子深处。" |
| 玛莎 | 温和 | `socialize`（随机目标） | low | "{name}和{target}坐在一起闲聊了一会儿。" |
| 汤姆 | 贪婪 | `work_gold` | medium | "{name}在盘算着什么赚钱的门路。" |
| 芬恩 | 懒散 | `rest` | medium | "{name}找了棵树靠着打了个盹。" |
| 艾达 | 坚韧 | `work_food` | low | "{name}默默干完了自己的活。" |

---

## 五、游戏状态与数值（12 个核心变量）

### 5.1 全局状态

| # | 变量名 | 类型 | 范围 | 初始值 | 说明 |
|---|--------|------|------|--------|------|
| 1 | `day` | int | 1~7 | 1 | 当前天数 |
| 2 | `food` | int | 0~150 | 60 | 村庄食物储备（每天消耗 = 存活村民数 × 2） |
| 3 | `wood` | int | 0~100 | 30 | 村庄木材储备 |
| 4 | `gold` | int | 0~50 | 10 | 村庄金币 |
| 5 | `morale` | int | 0~100 | 60 | 村庄整体士气（公式见下） |

**食物消耗**：每天消耗 = 存活村民数 × 2。初始 6 人 → 每天 12。初始 60 食物可支撑 5 天（不采集的情况下），给玩家足够的决策空间去关注"村民关系"这条核心线。

**士气计算公式**：

```
morale = clamp( avg(所有存活村民的 mood) + 50 + event_modifier, 0, 100 )
```

- `avg(mood)` 范围 -100~+100，+50 后映射到 -50~+150
- `event_modifier` 默认 0，由事件临时修正（如篝火晚会 +10，危机 -15 等）
- 最终 clamp 到 0~100

### 5.2 每村民状态（×6 人）

| # | 变量名 | 类型 | 范围 | 初始值 | 说明 |
|---|--------|------|------|--------|------|
| 6 | `mood` | int | -100~100 | 随性格 | 心情（<-50 可能争吵/出走） |
| 7 | `health` | int | 0~100 | 80~100 | 健康（=0 则病倒无法行动，status → sick） |
| 8 | `loyalty` | int | 0~100 | 50~70 | 对领主忠诚度（<20 时 LLM 可能输出 prepare_flee） |
| 9 | `relationships` | int[6] | -100~100 | 按设定 | 与其他 5 个村民的关系值 |
| 10 | `status` | enum | — | normal | `normal` / `sick` / `preparing_flee` / `fled` |
| 11 | `memory` | string[] | 最多 5 条 | [] | 最近的关键事件记忆摘要（供 LLM 参考，FIFO） |

### 5.3 事件队列

| # | 变量名 | 类型 | 说明 |
|---|--------|------|------|
| 12 | `active_events` | Event[] | 当前激活的事件列表（危机/机遇） |

### 5.4 胜负条件

| 条件 | 触发 | 结局类型 | 结局文本 |
|------|------|---------|---------|
| **饥荒** | `food ≤ 0` 且无法补充 | 失败 | "村庄陷入饥荒，村民们四散而去……" |
| **众叛亲离** | 存活且未出走的村民 < 3 | 失败 | "村民们一个接一个地离开了，村庄空无一人……" |
| **暴动** | `morale ≤ 0` | 失败 | "不满的村民掀起了暴动，你被赶下了领主之位……" |
| **繁荣** | 第 7 天结束，`morale ≥ 60` 且存活 ≥ 5 人 | 胜利（金） | "在你的英明领导下，村庄欣欣向荣！" |
| **存活** | 第 7 天结束，`morale ≥ 30` 且存活 ≥ 3 人 | 胜利（银） | "虽然磕磕绊绊，但村庄活了下来。" |
| **崩溃** | 第 7 天结束，不满足上述胜利条件 | 失败 | "村庄在风雨飘摇中走向了终结……" |

---

## 六、6 位固定村民设定

> 设计原则：6 人之间存在天然的性格张力，无需外部事件也能自发产生冲突与合作。

### 村民一览表

| ID | 姓名 | 职业 | 性格标签 | 初始心情 | 初始忠诚 | 核心矛盾点 |
|----|------|------|---------|---------|---------|-----------|
| `herman` | 赫尔曼 | 老铁匠 | 勤劳 / 固执 / 正直 | +30 | 70 | 看不惯偷懒的人 → 与芬恩冲突 |
| `ella` | 艾拉 | 年轻猎人 | 勇敢 / 冲动 / 重情义 | +20 | 60 | 冲动行事 → 容易把小事闹大 |
| `martha` | 玛莎 | 药草师 | 温和 / 聪慧 / 胆小 | +10 | 65 | 害怕冲突 → 关键时刻可能退缩 |
| `tom` | 汤姆 | 农夫 | 贪婪 / 务实 / 多疑 | +5 | 45 | 总想多拿 → 容易被其他人敌视 |
| `finn` | 芬恩 | 流浪诗人 | 懒散 / 魅力 / 狡猾 | +40 | 40 | 不爱干活 → 赫尔曼的天敌 |
| `ada` | 艾达 | 寡妇 | 坚韧 / 善良 / 悲观 | -10 | 55 | 容易消沉 → 需要鼓励才能发挥潜力 |

### 初始关系矩阵

| | 赫尔曼 | 艾拉 | 玛莎 | 汤姆 | 芬恩 | 艾达 |
|---|--------|------|------|------|------|------|
| **赫尔曼** | — | +20 | +15 | -10 | -30 | +10 |
| **艾拉** | +20 | — | +25 | -15 | +5 | +10 |
| **玛莎** | +15 | +25 | — | 0 | +10 | +20 |
| **汤姆** | -10 | -15 | 0 | — | -5 | -10 |
| **芬恩** | -30 | +5 | +10 | -5 | — | +15 |
| **艾达** | +10 | +10 | +20 | -10 | +15 | — |

### 天然张力分析

- **赫尔曼 vs 芬恩**（-30）：勤劳老铁匠 vs 懒散诗人——最容易爆发的冲突线
- **艾拉 vs 汤姆**（-15）：正义冲动的猎人 vs 贪婪多疑的农夫——容易因资源分配冲突
- **玛莎 & 艾达**（+20）：温和药草师 & 善良寡妇——最稳固的友谊线，但两人都偏被动
- **芬恩 & 艾达**（+15）：诗人会讲故事哄寡妇开心——潜在的情感线
- **汤姆的孤立**：汤姆与大多数人关系为负，是最容易出走的人——但他也是最会种地的

---

## 七、事件系统（条件化时间线）

### 7.1 事件时间表（原型版，含条件分支）

| 天 | 事件类型 | 触发条件 | 事件内容 | 触发效果 |
|----|---------|---------|---------|---------|
| 1 | 引导 | 固定 | 领主到任：村庄概况介绍 | 晨报展示 6 位村民简介，引导操作 |
| 2 | 小机遇 | 固定 | "村口发现一小批野果" | 食物 +10，引导玩家看状态变化 |
| 3 | **条件分支** | 见下 | 根据村民关系动态选择 | 见下 |
| 4 | 资源压力 | 固定 | "连日阴雨，今日采集效率减半" | 当日所有 `work_*` 产出 ×0.5 |
| 5 | **重大危机** | 随机三选一 | 干旱 / 盗匪 / 瘟疫 | 持续影响 2 天 |
| 6 | 危机持续 | 承接第 5 天 | 危机第二天 | 根据玩家应对调整严重度 |
| 7 | 终局 | 固定 | 危机结束，结算 | 生成编年史 |

### 7.2 第 3 天条件分支

| 条件 | 事件 | 效果 |
|------|------|------|
| 赫尔曼 vs 芬恩关系 ≤ -25 | "赫尔曼与芬恩公开对峙" | 两人关系 -10，全村士气 event_modifier -5，玩家需决定是否介入 |
| 赫尔曼 vs 芬恩关系 > -25（玩家已调解） | "汤姆被发现私藏物资" | 汤姆忠诚 -10，全体与汤姆关系 -5，食物追回 +3 |
| 如果以上都不适用 | "村民们因分工不均产生抱怨" | 全村士气 event_modifier -8 |

### 7.3 第 5 天重大危机池（随机抽 1 个）

| 危机 | 描述 | 持续效果 | 应对政策选项 |
|------|------|---------|------------|
| **干旱** | "水源枯竭，庄稼枯萎" | 每天食物额外消耗 +8，村民健康 -5/天 | ①寻找水源（木材 -15，60% 概率解除）②配给制（士气 -15）③祈雨仪式（芬恩主导，随机效果）④不采取行动（维持现状） |
| **盗匪** | "盗匪在林中出没" | 每天 30% 概率被抢走食物 5~10 | ①加固防御（木材 -20）②组织巡逻（食物 -8，艾拉主导）③交保护费（金币 -15）④不采取行动 |
| **瘟疫** | "不明疾病蔓延" | 每天随机 1~2 人健康 -15 | ①隔离（效率降低）②治疗（玛莎主导，金币 -10）③听天由命（高风险）④不采取行动 |

> **设计说明**：每个危机都有一个"不采取行动"选项，保证玩家永远有选择，但不作为是最高风险策略。

---

## 八、玩家操作详细设计

### 8.1 操作 A：颁布政策

每天可颁布 1 条政策（也可选择不颁布）。政策列表根据当前状态动态筛选：

| 政策 ID | 名称 | 效果 | 显示条件 |
|---------|------|------|---------|
| `free_day` | "自由行动" | 不做特别安排，村民按自己意愿行动 | **常驻（默认选项）** |
| `focus_food` | "全力采集食物" | `work_food` 产出 +30% | 常驻 |
| `focus_wood` | "全力伐木" | `work_wood` 产出 +30% | 常驻 |
| `hold_feast` | "举办篝火晚会" | 食物 -15，全员心情 +15，event_modifier +10 | food ≥ 20 |
| `rest_day` | "宣布休息日" | 全员倾向 rest，健康 +10，心情 +5 | 常驻 |
| `enforce_order` | "严肃纪律" | 所有 `work_*` 产出 +20%，全员心情 -3 | 常驻 |
| `ration` | "实行配给制" | 每日食物消耗减半（向上取整），士气 event_modifier -10 | food ≤ 30 |
| `fortify` | "加固村庄防御" | 木材 -20，盗匪抢劫概率 → 0% | 盗匪事件激活 |
| `organize_patrol` | "组织巡逻" | 食物 -8，盗匪抢劫概率 → 10%（艾拉主导时 → 0%） | 盗匪事件激活 |
| `quarantine` | "隔离病患" | 病倒村民不传染但无法行动 | 瘟疫事件激活 |
| `seek_water` | "寻找新水源" | 木材 -15，60% 概率解除干旱 | 干旱事件激活 |

### 8.2 操作 B：与村民交谈

每天可与 1 名村民交谈（也可跳过）。选择村民后出现话题选项：

| 话题 ID | 名称 | 效果 | 适用场景 |
|---------|------|------|---------|
| `encourage` | 鼓励 | 目标心情 +10，忠诚 +5 | 任何时候 |
| `warn` | 警告 | 目标忠诚 +8，心情 -5，打断 prepare_flee 倾向 | 有人偷窃/准备出走时 |
| `inquire` | 打听消息 | 无数值变化，展示该村民上一天的认知链信息（观察/评估/反思） | 任何时候 |
| `mediate` | 调解关系 | 目标与冲突方关系 +10，双方心情 +5 | 两人关系 < -20 时 |
| `gift` | 赠送物资 | 消耗金币 5 或食物 5，目标心情 +15，忠诚 +10 | 任何时候 |
| `assign_task` | 委以重任 | 目标在危机应对中效果翻倍（如艾拉巡逻、玛莎治疗） | 危机事件激活时 |

**"打听消息"（inquire）实现方式**：

不调用 LLM。直接用该村民上一天的 `reflect`（反思）+ 关系数据拼接展示：

```
"赫尔曼最近心情不错（+30），但对芬恩很不满（关系 -30）。
他在想：'那个吟游诗人迟早要被我赶出村子。'
他最信任的人是艾拉（关系 +20）。"
```

> 零 LLM 成本，体验足够用。后续版本可升级为 LLM 动态生成回复。

---

## 九、UI / 页面草图（文字版）

### 9.1 页面流程

```
[启动页] → [API 设置弹窗] → [主游戏页] → [结局页]
                                  ↑
                          （发现未完成存档时）
                          弹窗："继续上次的游戏？"
```

### 9.2 启动页（Start Screen）

```
┌──────────────────────────────────────────────────────────┐
│                                                          │
│              🏰  小 村 庄 领 主  🏰                       │
│              Village Lord                                │
│                                                          │
│         ─── 一段由 AI 书写的村庄编年史 ───                  │
│                                                          │
│              [ ⚙ 设置 API Key ]                          │
│                                                          │
│              [   开 始 游 戏   ]（API 配置后可用）          │
│                                                          │
│         v0.2 原型  ·  需要自行提供大模型 API Key           │
└──────────────────────────────────────────────────────────┘
```

### 9.3 API 设置页（Settings Panel / Modal）

```
┌──────────────────────────────────────────────────────────┐
│  ⚙ API 设置                                        [✕]  │
│  ─────────────────────────────────────────────────────── │
│                                                          │
│  服务商：[ ▼ 请选择 ────────────────── ]                  │
│          │ 豆包（火山引擎）             │                  │
│          │ DeepSeek                    │                  │
│          │ OpenAI                      │                  │
│          │ OpenAI 兼容（自定义）         │                  │
│          └─────────────────────────────┘                  │
│                                                          │
│  API Key：[________________________________]              │
│           🔒 密钥仅存储在本地浏览器中，不会上传              │
│                                                          │
│  模型名称：[________________________________]             │
│           （已根据服务商自动填入推荐模型）                    │
│                                                          │
│  API 地址：[________________________________]             │
│           （已根据服务商自动填入，自定义时需手动填写）         │
│                                                          │
│  ── 高级设置（可选） ──                                    │
│                                                          │
│  CORS 代理地址：[________________________________]        │
│           如直连 API 遇跨域错误，可填入代理地址              │
│           例：https://your-proxy.workers.dev              │
│           💡 留空则直连 API                                │
│                                                          │
│              [ 测试连接 ]    [ 保存 ]                      │
│                                                          │
│  💡 推荐使用豆包或 DeepSeek，成本最低（每局约 ¥0.1~0.3）   │
│  ⚠ 如遇"CORS 跨域错误"，请展开高级设置填入代理地址         │
└──────────────────────────────────────────────────────────┘
```

**CORS 代理工作方式**：

```
无代理（直连）：  浏览器 → fetch(apiBase + "/chat/completions")
有代理：          浏览器 → fetch(proxyUrl + "?target=" + encodeURIComponent(apiBase + "/chat/completions"))
```

代理服务器只做透传（转发请求 + 附加 CORS 头），不存储任何数据。项目附送一份 Cloudflare Workers 一键部署脚本（约 20 行代码）。

**Provider 预设配置表**：

| 服务商 | API Base | 推荐模型 | 备注 |
|--------|----------|---------|------|
| 豆包（火山引擎） | `https://ark.cn-beijing.volces.com/api/v3` | `doubao-1.5-pro-32k` | 需火山引擎 API Key |
| DeepSeek | `https://api.deepseek.com` | `deepseek-chat` | 性价比极高 |
| OpenAI | `https://api.openai.com` | `gpt-4o-mini` | 稳定但稍贵 |
| OpenAI 兼容 | 用户自填 | 用户自填 | 支持所有兼容接口 |

### 9.4 主游戏页（Main Game Screen）

```
┌──────────────────────────────────────────────────────────────────────┐
│  第 3 天 / 共 7 天                          🏰 村庄士气: ████░░ 62   │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│  🌾 食物: 48/150   🪵 木材: 28/100   💰 金币: 8/50                  │
│                                                                      │
│ ┌─── 📜 今日晨报 ──────────────────────┐┌─── 👥 村民状态 ──────────┐│
│ │                                      ││                          ││
│ │  ☀ 第 3 天，晴朗                      ││  [😊] 赫尔曼 ♥70 😃+30  ││
│ │                                      ││  铁匠 · 勤劳/固执/正直    ││
│ │  📋 昨日要事：                        ││  ──────────────────────  ││
│ │                                      ││  [😐] 艾拉   ♥60 😃+20  ││
│ │  · 赫尔曼天没亮就扛着锄头出门，一      ││  猎人 · 勇敢/冲动/重情义  ││
│ │    个人干了三个人的活。                 ││  ──────────────────────  ││
│ │                                      ││  [😊] 玛莎   ♥65 😃+10  ││
│ │  · 芬恩无视了政策，端着琴去找艾达      ││  药草师 · 温和/聪慧/胆小  ││
│ │    弹曲子。艾达难得露出了笑容。         ││  ──────────────────────  ││
│ │                                      ││  [😕] 汤姆   ♥45 😃+5   ││
│ │  · 汤姆闷头种地，但总觉得别人在        ││  农夫 · 贪婪/务实/多疑    ││
│ │    占他便宜。                          ││  ──────────────────────  ││
│ │                                      ││  [😄] 芬恩   ♥40 😃+40  ││
│ │  ⚠ 事件：赫尔曼与芬恩的矛盾升级，     ││  诗人 · 懒散/魅力/狡猾    ││
│ │  两人在村口公开对峙。气氛十分紧张。     ││  ──────────────────────  ││
│ │                                      ││  [😞] 艾达   ♥55 😃-10  ││
│ │                                      ││  寡妇 · 坚韧/善良/悲观    ││
│ │                                      ││                          ││
│ │                                      ││  点击村民查看详情 ▸       ││
│ └──────────────────────────────────────┘└──────────────────────────┘│
│                                                                      │
│ ┌─── 🎯 今日决策 ──────────────────────────────────────────────────┐│
│ │                                                                    ││
│ │  📜 颁布政策（选一项）：                                            ││
│ │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────┐ ││
│ │  │ 🌾 全力采食  │ │ 🪵 全力伐木  │ │ 🎉 篝火晚会  │ │ ☁ 自由   │ ││
│ │  │ 食物产出+30% │ │ 木材产出+30% │ │ 消耗食物15   │ │ 行动     │ ││
│ │  │              │ │              │ │ 全员心情+15  │ │ （不干预）│ ││
│ │  └──────────────┘ └──────────────┘ └──────────────┘ └──────────┘ ││
│ │                                                                    ││
│ │  💬 与村民交谈（可选）：                                            ││
│ │  [ 选择村民 ▼ ]  [ 选择话题 ▼ ]   [ 确认交谈 ]    [ 跳过 ]         ││
│ │                                                                    ││
│ │              [ ☀ 结束今天，进入下一天 → ]                           ││
│ └────────────────────────────────────────────────────────────────────┘│
└──────────────────────────────────────────────────────────────────────┘
```

### 9.5 村民详情弹窗（点击村民后）

```
┌──────────────────────────────────────────┐
│  赫尔曼 · 老铁匠                    [✕]  │
│  ─────────────────────────────────────── │
│  性格：勤劳 / 固执 / 正直                 │
│                                          │
│  😃 心情: ██████░░░░  +30                │
│  ❤️ 健康: █████████░  90                 │
│  👑 忠诚: ███████░░░  70                 │
│                                          │
│  📊 人际关系：                             │
│    艾拉   ████░░ +20  友善               │
│    玛莎   ███░░░ +15  友善               │
│    汤姆   █░░░░░ -10  冷淡               │
│    芬恩   ░░░░░░ -30  敌视 ⚠             │
│    艾达   ██░░░░ +10  普通               │
│                                          │
│  📝 近期记忆：                             │
│    · 昨天打了一整天铁，很充实              │
│    · 看到芬恩又在偷懒，很生气              │
│                                          │
│  🧠 认知快照（上一天）：                    │
│    观察："领主下令全力采食物。芬恩又靠在    │
│          树下弹琴。"                       │
│    评估："领主有远见。芬恩迟早拖垮全村。"   │
│    反思："先不管芬恩了，我要更卖力。"       │
│                                          │
│  💭 内心想法：                             │
│    "那个吟游诗人迟早要被我赶出村子。"       │
└──────────────────────────────────────────┘
```

### 9.6 确认弹窗（点击"结束今天"后）

```
┌──────────────────────────────────────────┐
│                                          │
│  ☀ 确定结束第 3 天？                      │
│                                          │
│  今日决策回顾：                            │
│    📜 政策：全力采集食物                    │
│    💬 交谈：鼓励了赫尔曼                   │
│                                          │
│  村民们将度过这一天……                     │
│                                          │
│       [ 取消 ]         [ 确定 → ]         │
│                                          │
└──────────────────────────────────────────┘
```

### 9.7 结局页（Ending Screen）

```
┌──────────────────────────────────────────────────────────┐
│                                                          │
│              📜 村 庄 编 年 史 📜                         │
│                                                          │
│  结局：勉强存活 🥈                                        │
│  存活天数：7 / 7                                          │
│  最终士气：38                                             │
│  存活村民：5 / 6（汤姆在第 6 天出走）                      │
│                                                          │
│  ─── 编年史摘要 ───                                       │
│                                                          │
│  第 1 天：新领主到任，一切平静……                           │
│  第 2 天：村口发现野果，食物有所补充。                      │
│  第 3 天：赫尔曼与芬恩爆发冲突，艾拉出面调解。              │
│  第 4 天：阴雨连绵，采集困难。玛莎帮助艾达恢复了精神。       │
│  第 5 天：盗匪出没！领主组织艾拉带队巡逻。                  │
│  第 6 天：汤姆因多次被其他人排挤，决定离开村庄。             │
│  第 7 天：盗匪退散，幸存的五人围坐在篝火旁。                │
│                                                          │
│  "虽然磕磕绊绊，但这个小村庄终究活了下来。"                 │
│                                                          │
│      [ 🔄 再来一局 ]    [ 📋 复制编年史 ]                  │
└──────────────────────────────────────────────────────────┘
```

---

## 十、素材方案（拼装集合体规则）

本原型**不依赖任何外部美术资源**，全部用 CSS + Unicode/Emoji + 简单色块实现。

### 10.1 视觉风格

- **主色调**：暖色系中世纪感（#8B7355 土棕 / #2D5016 深绿 / #D4A84B 金色 / #E8DCC8 羊皮纸底色）
- **字体**：`system-ui, "Segoe UI", Arial, sans-serif`（系统字体，无需加载）
- **风格关键词**：古卷轴感 / 简洁实用 / 文字为王

### 10.2 图标方案（全部用 Emoji / Unicode）

| 元素 | 图标 |
|------|------|
| 食物 | 🌾 |
| 木材 | 🪵 |
| 金币 | 💰 |
| 士气 | 🏰 |
| 村民心情 | 😄😊😐😕😢 （按数值区间映射） |
| 健康 | ❤️ |
| 忠诚 | 👑 |
| 天气/事件 | ☀️🌧️⚠️🔥🗡️🦠 |
| 关系 | 💚（正面）/ 💔（负面） |

### 10.3 色板

| 用途 | 颜色 | HEX |
|------|------|-----|
| 背景（羊皮纸） | 浅棕 | #F5E6CA |
| 面板背景 | 深羊皮纸 | #E8DCC8 |
| 正面数值 | 森林绿 | #2D5016 |
| 负面数值 | 暗红 | #8B2500 |
| 主按钮 | 土金色 | #D4A84B |
| 边框/分割线 | 棕色 | #8B7355 |
| 文本 | 深棕 | #3E2723 |
| 危机/警告 | 暗红 | #C62828 |

---

## 十一、技术实现与目录结构（纯 Web）

### 11.1 目录结构

```
VillageLord/
├── index.html              # 入口页面
├── css/
│   └── style.css           # 全部样式（羊皮纸风格）
├── js/
│   ├── config.js           # 【最先加载】所有配置常量 + 效果查表
│   ├── utils.js            # 通用工具（随机、clamp、RNG）
│   ├── logger.js           # 统一日志 + Error Overlay
│   ├── storage.js          # localStorage 存取（API 配置 + 游戏存档）
│   ├── llm-api.js          # LLM API 封装（多 Provider + CORS 代理支持）
│   ├── prompt-builder.js   # Prompt 模板组装（系统提示 + 动态上下文）
│   ├── villagers.js        # 村民数据定义 + 状态管理
│   ├── world.js            # 世界状态管理（资源/事件/天数）
│   ├── game-logic.js       # 核心游戏逻辑（回合流程、解析、效果查表、结算）
│   ├── ui.js               # UI 渲染与交互（DOM 操作）
│   └── main.js             # 入口：初始化、状态机、页面切换
├── worker/                  # （附送）CORS 代理脚本
│   └── cors-proxy.js       # Cloudflare Workers 一键部署脚本
└── assets/                  # （可选，原型阶段为空）
    └── (预留)
```

### 11.2 关键模块与职责

| 模块 | 职责 | 关键接口 |
|------|------|---------|
| `config.js` | 所有常量：数值、白名单、效果查表、Provider 预设 | `CONFIG.Balance.*`, `CONFIG.Effects.*`, `CONFIG.Providers.*` |
| `llm-api.js` | 封装 `fetch`，统一 OpenAI 兼容格式，支持 CORS 代理 | `LLMApi.chat(messages) → Promise<string>` |
| `prompt-builder.js` | 组装系统提示 + 村民上下文 + 玩家决策 → messages 数组 | `PromptBuilder.buildDayPrompt(state) → messages[]` |
| `game-logic.js` | 回合编排：LLM → 解析 → 效果查表 → 更新 → 检查胜负 | `GameLogic.processTurn() → Promise<DayReport>` |
| `villagers.js` | 村民数据 + 认知链存储 + 状态管理 | `Villagers.get(id)`, `Villagers.getLastCognition(id)` |
| `world.js` | 资源、事件、天数管理 | `World.nextDay()`, `World.consumeFood()` |
| `storage.js` | API 配置存取 + 游戏存档（自动保存/恢复） | `Storage.saveGame(state)`, `Storage.loadGame()` |
| `ui.js` | 所有 DOM 操作 / 页面渲染 / 交互绑定 | `UI.renderMorningReport()`, `UI.showConfirmDialog()` |
| `logger.js` | 统一日志 + Error Overlay + 诊断信息复制 | `Logger.info/warn/error()`, `Logger.showOverlay()` |

### 11.3 API Key 接入方式

- **存储**：`localStorage`（key: `village_lord_api_config`），仅存在用户浏览器本地
- **CORS 代理**：若用户填写了代理地址，`llm-api.js` 会将请求路由到 `proxyUrl + "?target=" + realApiUrl`
- **绝不**将 Key 写入代码、绝不提交到仓库、绝不上传到任何服务器
- **读取**：游戏启动时从 `localStorage` 读取；无配置则强制跳转设置页
- **测试**：设置页提供"测试连接"按钮，发送一条简短请求验证 Key 和代理可用

### 11.4 自动存档机制

- **触发**：每天结算完成后自动存档到 `localStorage`（key: `village_lord_save`）
- **恢复**：启动页检测到未完成存档 → 弹窗"发现未完成的游戏，是否继续？"
- **存档内容**：完整游戏状态（天数、资源、全体村民状态+记忆+认知链、事件队列、编年史日志）
- **清理**：一局结束后自动删除存档

### 11.5 `index.html` 加载顺序

```html
<link rel="stylesheet" href="css/style.css">

<script src="js/config.js"></script>
<script src="js/utils.js"></script>
<script src="js/logger.js"></script>
<script src="js/storage.js"></script>
<script src="js/llm-api.js"></script>
<script src="js/prompt-builder.js"></script>
<script src="js/villagers.js"></script>
<script src="js/world.js"></script>
<script src="js/game-logic.js"></script>
<script src="js/ui.js"></script>
<script src="js/main.js"></script>
```

---

## 十二、验收用例（8 条）

### 用例 1：正常回合——村民按性格行动 + 认知链输出

| 项 | 内容 |
|----|------|
| **前置** | 第 1 天，玩家颁布"全力采集食物" |
| **期望 LLM 输出** | 赫尔曼（勤劳）→ `work_food/high`，芬恩（懒散）→ `rest/medium`。认知链中赫尔曼 evaluate 提到"领主有远见"，芬恩 evaluate 提到"又要干活，烦死了" |
| **期望状态** | 食物 +12（赫尔曼 high），芬恩无产出但心情 +8（休息） |
| **失败兜底** | LLM 格式错误 → 拆组重试 → 仍失败 → 全体模板行为 |

### 用例 2：政策影响——篝火晚会提升士气

| 项 | 内容 |
|----|------|
| **前置** | 食物 ≥ 20，玩家颁布"举办篝火晚会" |
| **期望 LLM 输出** | 多数村民 `socialize`，diary 描述晚会场景 |
| **期望状态** | 食物 -15，全员心情 +15，event_modifier +10，关系趋正 |
| **程序保证** | 即使 LLM 输出非 socialize 行为，程序仍强制执行心情 +15 和 event_modifier +10 |

### 用例 3：冲突涌现——赫尔曼 vs 芬恩

| 项 | 内容 |
|----|------|
| **前置** | 第 2~3 天，两人关系 ≤ -25 |
| **期望 LLM 输出** | 赫尔曼 → `argue/high, target: finn`。认知链：observe 提到芬恩偷懒，evaluate "不可接受"，reflect "忍不了了" |
| **期望状态** | 赫尔曼-芬恩关系 -15（high），双方心情下降 |
| **与预设事件的关系** | 若第 3 天关系仍 ≤ -25，预设事件"公开对峙"补充升级；否则跳转备选事件 |

### 用例 4：交谈干预——玩家调解冲突

| 项 | 内容 |
|----|------|
| **前置** | 赫尔曼 vs 芬恩关系 < -20，玩家选择与赫尔曼交谈 → 调解 |
| **期望状态** | 赫尔曼-芬恩关系 +10，双方心情 +5 |
| **期望 LLM 后续** | 下一天赫尔曼的 memory 包含"领主调解了我和芬恩的矛盾"，行为不再选 argue |
| **证明策略性** | 不调解 → 冲突升级；调解 → 缓和。玩家选择直接改变走向 |

### 用例 5：危机应对——盗匪来袭 + 委以重任

| 项 | 内容 |
|----|------|
| **前置** | 第 5 天盗匪事件，玩家选"组织巡逻" + 与艾拉交谈 → 委以重任 |
| **期望状态** | 食物 -8，艾拉主导巡逻 → 抢劫概率 0%（委以重任翻倍效果） |
| **期望 LLM 输出** | 艾拉 `work_wood/high`（巡逻属于外出），diary 描述英勇巡逻 |
| **移除 LLM 的后果** | 无法生成个性化危机反应，所有日志退化为模板文本 |

### 用例 6：连锁反应——汤姆出走

| 项 | 内容 |
|----|------|
| **前置** | 汤姆忠诚 < 20，LLM 输出 `prepare_flee` |
| **期望流程** | Day N: status→preparing_flee, 晨报提示 → Day N+1: 玩家可干预 → 若未干预且忠诚<20 → 自动出走 |
| **期望状态** | 村民 -1，其他人心情各 -5 |
| **证明涌现感** | 出走是性格+关系+政策累积的自然结果，非预设脚本 |

### 用例 7：LLM 完全不可用时的降级

| 项 | 内容 |
|----|------|
| **前置** | API 连接失败 / 超时 |
| **期望行为** | 全体村民使用模板行为（按性格 + 默认强度），生成模板日志 |
| **期望状态** | 游戏可继续，数值按效果表 × 默认强度变化 |
| **用户感知** | 日志顶部显示 "[⚠ 简化模式] 模型连接失败，村民行为已自动模拟" |

### 用例 8：编年史生成 + 存档恢复

| 项 | 内容 |
|----|------|
| **前置** | 第 7 天结束 / 中途关闭浏览器后重新打开 |
| **编年史** | 汇总 7 天关键事件，每天 1~2 句话，两次游玩明显不同 |
| **存档恢复** | 关闭后重开 → 弹窗"发现未完成的游戏" → 点击继续 → 恢复到关闭前状态 |

---

## 十三、开发里程碑（按天拆分）

### Day 1：骨架搭建（可运行的空壳）

- [ ] 创建目录结构 + `index.html` + `style.css` + `config.js`（含效果查表）
- [ ] 实现 `logger.js`（Error Overlay + 全局错误捕获）
- [ ] 实现 `storage.js`（API 配置 + 游戏存档读写）
- [ ] 实现 API 设置页 UI（Provider 下拉 + Key + CORS 代理 + 测试连接）
- [ ] 实现 `llm-api.js`（OpenAI 兼容 fetch + CORS 代理透传）
- [ ] **先验证 CORS**：测试豆包/DeepSeek 直连是否可用，不可用则测试代理
- [ ] 验证：能在设置页输入 Key，点击测试连接，收到 LLM 回复

### Day 2：游戏核心数据 + UI 框架

- [ ] 实现 `villagers.js`（6 个村民数据 + 认知链存储 + 状态管理）
- [ ] 实现 `world.js`（资源管理 + 天数推进 + 食物消耗 + 士气公式 + 事件队列）
- [ ] 实现主游戏页 UI 框架（晨报区 + 村民面板 + 决策区）
- [ ] 实现村民详情弹窗（含认知快照展示）
- [ ] 实现第 1 天特殊晨报（村庄概况引导）
- [ ] 验证：能看到 6 个村民的初始状态 + 资源面板 + 村庄介绍

### Day 3：核心循环跑通

- [ ] 实现 `prompt-builder.js`（组装 OMERA 认知链提示 + 动态上下文）
- [ ] 实现 `game-logic.js`（回合流程 + JSON 解析 + 效果查表 + 状态更新）
- [ ] 实现偷窃机制（检测概率 + 后果）
- [ ] 实现降级方案（批量失败 → 拆组 → 模板行为）
- [ ] 连通：玩家选政策 → 确认弹窗 → 调 LLM → 解析 → 查表更新 → 显示日志
- [ ] 验证：能完成一个完整回合，看到村民行动日志 + 认知链

### Day 4：完善玩法 + 事件系统

- [ ] 实现交谈系统（选村民 + 选话题 → 数值效果 + 写入记忆）
- [ ] 实现打听消息（inquire）零成本展示
- [ ] 实现条件化事件时间表（第 2~7 天）
- [ ] 实现出走机制（prepare_flee → 干预窗口 → 自动出走）
- [ ] 实现胜负条件检查 + 自动存档
- [ ] 实现结局页 + 编年史生成 + 复制功能
- [ ] 验证：能完整打完一局 7 天游戏

### Day 5：打磨 + 测试 + 修 Bug

- [ ] UI 美化（羊皮纸配色、动画过渡、加载状态）
- [ ] LLM 等待体验（"村民们正在度过这一天……"+ 主题化加载画面）
- [ ] 存档恢复流程测试
- [ ] 全流程测试 × 3 局以上（含降级模式测试）
- [ ] 修复 Bug + 调整数值平衡
- [ ] 编写 CORS 代理一键部署脚本（`worker/cors-proxy.js`）
- [ ] 验证：所有 8 条验收用例通过

---

## 十四、附录：LLM 调用示例（完整请求/响应）

### 请求示例（一次处理全体村民）

```json
{
  "model": "doubao-1.5-pro-32k",
  "messages": [
    {
      "role": "system",
      "content": "你是一个中世纪村庄模拟引擎……（完整系统提示词见 4.3 节）"
    },
    {
      "role": "user",
      "content": "## 当前世界状态\n天数: 3/7\n食物: 48, 木材: 28, 金币: 8\n村庄士气: 62\n今日天气: 晴朗\n活跃事件: 无\n\n## 领主今日决策\n政策: 全力采集食物\n交谈: 与赫尔曼交谈 → 鼓励\n\n## 村民档案\n\n### herman（赫尔曼·老铁匠）\n性格: 勤劳/固执/正直\n心情: +30, 健康: 90, 忠诚: 70\n关系: {ella: +20, martha: +15, tom: -10, finn: -30, ada: +10}\n记忆: [\"昨天卖力干活采了不少粮\", \"领主鼓励了我\", \"芬恩又在偷懒\"]\n\n### ella（艾拉·猎人）\n性格: 勇敢/冲动/重情义\n心情: +20, 健康: 85, 忠诚: 60\n关系: {herman: +20, martha: +25, tom: -15, finn: +5, ada: +10}\n记忆: [\"昨天去林子里砍了些木材\", \"汤姆好像偷拿了东西\"]\n\n### martha（玛莎·药草师）\n性格: 温和/聪慧/胆小\n心情: +10, 健康: 80, 忠诚: 65\n关系: {herman: +15, ella: +25, tom: 0, finn: +10, ada: +20}\n记忆: [\"和艾达聊了很久，她心情好了些\"]\n\n### tom（汤姆·农夫）\n性格: 贪婪/务实/多疑\n心情: +5, 健康: 85, 忠诚: 45\n关系: {herman: -10, ella: -15, martha: 0, finn: -5, ada: -10}\n记忆: [\"辛苦种地但没人感谢我\", \"觉得领主偏心赫尔曼\"]\n\n### finn（芬恩·诗人）\n性格: 懒散/魅力/狡猾\n心情: +40, 健康: 95, 忠诚: 40\n关系: {herman: -30, ella: +5, martha: +10, tom: -5, ada: +15}\n记忆: [\"赫尔曼又骂我了\", \"给艾达弹了琴她很开心\"]\n\n### ada（艾达·寡妇）\n性格: 坚韧/善良/悲观\n心情: -10, 健康: 75, 忠诚: 55\n关系: {herman: +10, ella: +10, martha: +20, tom: -10, finn: +15}\n记忆: [\"芬恩给我弹了首好听的曲子\", \"今天又想起了以前的事\"]\n\n## 请为每个村民按照「观察→记忆→评估→反思→行动」的认知链输出行动决策，返回 JSON 数组："
    }
  ],
  "temperature": 0.8,
  "max_tokens": 2000
}
```

### 期望响应示例（展示 3 人，实际为 6 人）

```json
[
  {
    "villager_id": "herman",
    "observe": "领主下令全力采食物。芬恩又靠在树下弹琴，完全没有干活的意思。",
    "remember": "昨天领主专门来鼓励我，说我是村庄的顶梁柱。",
    "evaluate": "领主是个有远见的人，知道食物才是命根子。但芬恩这个废物迟早拖垮全村。",
    "reflect": "先不管芬恩了，领主看得到我的付出，我要更加卖力才行。",
    "action": "work_food",
    "target": null,
    "intensity": "high",
    "diary": "赫尔曼天没亮就扛着锄头出了门，一个人干了三个人的活。回来时累得腰都直不起来，但扛回的粮食堆得老高。"
  },
  {
    "villager_id": "finn",
    "observe": "领主又在催大家干活。赫尔曼一大早就出去了。艾达今天好像心情不太好。",
    "remember": "前天赫尔曼当众骂我偷懒。不过昨天给艾达弹琴她很开心。",
    "evaluate": "这种只知道干活的日子有什么意思？人活着不就图个开心吗。",
    "reflect": "今天不想干活。去找艾达吧，她需要有人陪她说说话。",
    "action": "socialize",
    "target": "ada",
    "intensity": "medium",
    "diary": "芬恩无视了领主的政策，端着旧琴溜达到艾达门前，给她弹了一首欢快的小曲。艾达难得露出了笑容。"
  },
  {
    "villager_id": "tom",
    "observe": "领主又让全力采食物。赫尔曼出去干活了，其他人各忙各的。没人注意我。",
    "remember": "辛苦种地但从来没人感谢我。领主好像更看重赫尔曼。",
    "evaluate": "反正我种出来的粮食也是大家分，凭什么我最辛苦。",
    "reflect": "今天少干点，反正也没人发现。不如偷偷留点口粮给自己。",
    "action": "steal",
    "target": null,
    "intensity": "low",
    "diary": "汤姆闷头在田里干了半天活，趁没人注意的时候，悄悄往自己屋里藏了一小袋粮食。"
  }
]
```

**程序处理流程**：

1. 解析 JSON → 校验每个对象
2. 查效果表：
   - herman: `work_food/high` → 食物 +12, 心情 -6, 健康 -6, 忠诚 +3
   - finn: `socialize(ada)/medium` → 芬恩心情 +5, 芬恩-艾达关系 +8, 双方心情各 +3
   - tom: `steal/low` → 食物 -2, 汤姆心情 +3 → 掷骰 40% 检测 → 若被发现…
3. 更新状态 + 生成日报 + 自动存档

---

## 十五、附录：CORS 代理脚本（Cloudflare Workers）

```javascript
// worker/cors-proxy.js
// 部署方式：在 Cloudflare Workers 控制台创建 Worker，粘贴此代码即可

addEventListener('fetch', event => {
  event.respondWith(handleRequest(event.request))
})

async function handleRequest(request) {
  // 处理预检请求
  if (request.method === 'OPTIONS') {
    return new Response(null, {
      headers: {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
        'Access-Control-Allow-Headers': 'Content-Type, Authorization',
        'Access-Control-Max-Age': '86400',
      }
    })
  }

  // 获取目标 URL
  const url = new URL(request.url)
  const target = url.searchParams.get('target')
  if (!target) {
    return new Response('Missing target parameter', { status: 400 })
  }

  // 转发请求
  const newRequest = new Request(target, {
    method: request.method,
    headers: request.headers,
    body: request.body,
  })

  const response = await fetch(newRequest)

  // 附加 CORS 头
  const newResponse = new Response(response.body, response)
  newResponse.headers.set('Access-Control-Allow-Origin', '*')
  return newResponse
}
```

---

> **⚠ API Key 状态**：本策划案设计为"玩家在游戏内自行输入 API Key"，Key 仅存储在浏览器本地 `localStorage` 中。进入开发阶段后，开发者需自行准备一个可用的 API Key 用于调试。
>
> **版本变更记录（v0.1 → v0.2）**：
> - 新增 OMERA 认知架构（观察-记忆-评估-反思-行动），替代直接输出数值
> - 数值变化改为程序查效果表计算，LLM 只输出 action + intensity
> - 食物消耗降至每人每天 2（原 3），防止"只能采食物"的伪决策
> - 新增士气计算公式、偷窃机制、出走详细流程
> - 第 3 天事件改为条件分支（防止与 LLM 涌现重复）
> - 新增"自由行动"默认政策 + "跳过交谈"选项 + 结束确认弹窗
> - 打听消息改为零 LLM 成本（使用上一天认知链数据）
> - 新增自动存档 + 存档恢复机制
> - 新增 CORS 代理方案 + 一键部署脚本
> - 删除 LLM 输出中的 event_trigger 字段（事件完全由程序控制）
